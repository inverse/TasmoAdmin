var ignoreProtectionsTimer;function initCommandHelper(){$(".showCommandInput").on("click",(function(t){$(this).toggleClass("btn-secondary").toggleClass("btn-primary"),$(".command-hidden").toggleClass("d-none"),$(".cmd_cb").toggleClass("d-none").find("input").prop("checked",!1),$(".cmdContainer ").removeClass("has-error"),$(".cmdContainer ").find("input").val(""),$(".cmdContainer ").find("#commandInputError").html("")})),$(".cmdContainer ").find("input").keypress((function(t){13==t.which&&$(".sendCommand").click()})),$(".select_all").change((function(){let t=this.checked;$(".device_checkbox").each((function(){this.checked=t})),$(".select_all").each((function(){this.checked=t}))})),$(".device_checkbox").change((function(){0==this.checked&&$(".select_all").each((function(){this.checked=!1})),$(".device_checkbox:checked").length==$(".device_checkbox").length&&$(".select_all").each((function(){this.checked=!0}))})),$(".sendCommand").on("click",(function(t){$(this).parent().parent().removeClass("has-error").find("#commandInputError").addClass("d-none").html("");let e=$.map($(".cmd_cb:not(.link ) input:not(.select_all):checked"),(function(t,e){return new Array($(t).val())}));if(0===e.length)return $(this).parent().parent().addClass("has-error").find("#commandInputError").removeClass("d-none").html($.i18n("ERROR_COMMAND_NO_DEVICE_SELECTED")),!1;let a=$(this).parent().parent().find(".commandInput").val();if(""===a)return $(this).parent().parent().addClass("has-error").find("#commandInputError").removeClass("d-none").html($.i18n("ERROR_PLS_ENTER_COMMAND")),!1;$.each(e,(function(t,e){console.log(e),Sonoff.generic(e,a,void 0,(function(t){console.log(t);let a=$("[data-device_id="+e+"]:first").find(".device_name a").text().trim();$("#commandInputError").append("ID "+e+" ("+a+") => "+JSON.stringify(t)+"<br/>")}))})),$(this).parent().parent().find("#commandInputError").removeClass("d-none").append($.i18n("SUCCESS_COMMAND_SEND")+"</br>")}))}function updateStatus(){$("#device-list tbody tr").each((function(t,e){let a=$(e).data("device_ip"),s=$(e).data("device_id"),i=$(e).data("device_relais"),o=$(e).data("device_group");if($(e).hasClass("updating"))console.log("[Devices][updateStatus]SKIP get status from "+$(e).data("device_ip"));else{if(console.log("[Devices][updateStatus]get status from "+$(e).data("device_ip")),$(e).addClass("updating"),"multi"===o&&i>1)return void console.log("[Devices][updateStatus]SKIP multi "+$(e).data("device_ip"));Sonoff.getStatus(a,s,i,(function(t){if(!t||t.ERROR||t.WARNING||""===t||void 0===t||void 0!==t.statusText)console.log("ERROR => "+JSON.stringify(t)),"multi"===o?$('#device-list tbody tr[data-device_group="multi"][data-device_ip="'+a+'"]').each((function(t,e){$(e).find(".status").find("input").parent().addClass("error"),$(e).find("td").each((function(t,e){$(e).find(".loader").length>0&&$(e).find("span").html("-")})),$(e).removeClass("updating")})):($(e).find(".status").find("input").parent().addClass("error"),$(e).removeClass("updating"));else if("multi"===o)$('#device-list tbody tr[data-device_group="multi"][data-device_ip="'+a+'"]').each((function(e,a){let s=$(a).data("device_relais"),i=Sonoff.parseDeviceStatus(t,s);updateRow($(a),t,i),$(a).removeClass("updating")}));else{let a=Sonoff.parseDeviceStatus(t,i);console.log(a),updateRow($(e),t,a)}}))}}))}function updateAllStatus(){let t=$("#device-list");if(t.hasClass("updating"))console.log("[Devices][updateAllStatus]SKIP");else{t.addClass("updating"),console.log("[Devices][updateAllStatus]START");let e=15*t.find("tbody tr").length;Sonoff.getAllStatus(e,(function(e){t.find("tbody tr").each((function(t,a){let s=$(a).data("device_id"),i=$(a).data("device_relais"),o=($(a).data("device_group"),e[s]||void 0);if(void 0===o||$.isEmptyObject(o)||o.ERROR||o.WARNING||""===o||void 0!==o.statusText){console.log("[LIST][updateAllStatus]["+s+"][ERROR] DATA => "+JSON.stringify(o)),$(a).hasClass("toggled")?$(a).removeClass("toggled"):$(a).find(".status").find("input").parent().addClass("error");let t=$.i18n("ERROR");void 0!==o?void 0!==o.ERROR?t=o.ERROR:void 0!==o.WARNING?t=o.WARNING:void 0!==o.statusText&&(t=o.statusText):t="data is empty",$(a).attr("data-original-title",t).attr("data-toggle","tooltip").tooltip({html:!0,delay:700}),$(a).find("td").each((function(t,e){$(e).find(".loader").length>0&&$(e).find("span").html("-")}))}else{console.log("[LIST][updateAllStatus]["+s+"]MSG => "+JSON.stringify(o));let t=Sonoff.parseDeviceStatus(o,i);$(a).removeAttr("data-original-title").removeAttr("data-toggle"),updateRow($(a),o,t),$(a).find(".status").find("input").parent().removeClass("error")}})),t.removeClass("updating")}))}}function deviceTools(){$("#device-list tbody tr td.status").on("click",(function(t){t.preventDefault();let e=$(this),a=$(this).closest("tr").data("device_ip"),s=$(this).closest("tr").data("device_id"),i=$(this).closest("tr").data("device_relais"),o=$(this).closest("tr").data("device_protect_on"),d=$(this).closest("tr").data("device_protect_off");if(e.find("input").prop("checked")){if(1===d&&!$(".ignoreProtections").prop("checked"))return;e.find("input").removeProp("checked")}else{if(1===o&&!$(".ignoreProtections").prop("checked"))return;e.find("input").prop("checked","checked")}$(this).closest("tr").addClass("toggled"),Sonoff.toggle(a,s,i,(function(t){if(!t||t.ERROR||t.WARNING)"OFF"===device_status?1===o?e.find("input").prop("disabled","disabled").parent().addClass("disabled"):e.find("input").removeProp("disabled","disabled").parent().removeClass("disabled"):e.find("input").parent().addClass("error");else{let a=Sonoff.parseDeviceStatus(t,i);console.log("device_status",a),"ON"===a&&(1===d?e.find("input").prop("disabled","disabled").parent().addClass("disabled"):e.find("input").removeProp("disabled","disabled").parent().removeClass("disabled"))}}))})),$("#deleteDeviceModal").on("show.bs.modal",(function(t){let e=$(this),a=$(t.relatedTarget);console.log(e.find(".btn-ok")),e.find(".btn-ok").attr("href",a.attr("href"));let s=a.data("dialog-text");e.find(".modal-body").html(s)})),$("#device-list tbody tr td a.restart-device").on("click",(function(t){t.preventDefault();let e=$(this).closest("tr").data("device_id");Sonoff.generic(e,"Restart",1)})),$(document).on("dblclick",".dblcEdit span",(function(){oriVal=$(this).text().toString().trim(),$(this).text("").addClass("dont-update");let t=10*oriVal.toString().length+20;input=$("<input class='dblEdit-Input form-control' type='text' style='width: "+t+"px; padding: 3px;'>"),input.appendTo($(this)).focus()})),$(document).on("focusout keypress",".dblEdit-Input",(function(t){if("keypress"!==t.type||13===t.which)if(""!==input.val()){let t=input.val(),e=$(this).closest("tr").data("device_id"),a=$(this).closest("td").data("target")||"device",s=$(this).closest("td").data("cmnd")||"",i=$(this).closest("td").data("field")||"";$(this).hide();let o=$(this).parent();$(this).parent().removeClass("dont-update").html($.i18n("TEXT_LOADING")).removeClass("dont-update"),"device"==a?Sonoff.updateConfig(e,s,t,updateStatus):"csv"==a&&Sonoff.setDeviceValue(e,i,t,o)}else $(this).parent().removeClass("dont-update").text(oriVal)}))}function updateRow(t,e,a){$(t).data("device_all_off");let s,i,o,d=$(t).data("device_protect_on"),n=$(t).data("device_protect_off"),l="n/A";void 0!==e.StatusFWR&&(l=parseVersion(e.StatusFWR.Version)),l>=510009?(s=e.StatusSTS.Wifi.RSSI,i=e.StatusSTS.Wifi.SSId,o=e.StatusSTS.Uptime):(s=e.StatusSTS.WLAN?e.StatusSTS.WLAN.RSSI:e.StatusSTS.Wifi.RSSI,i=e.StatusSTS.WLAN?e.StatusSTS.WLAN.SSID:e.StatusSTS.Wifi.SSId,o=e.StatusSTS.Laufzeit?e.StatusSTS.Laufzeit:e.StatusSTS.Uptime);let r=getEnergyPower(e);""!==r&&($(t).find(".energyPower span").html(r),$("#device-list .energyPower").removeClass("hidden"));let c=getTemp(e);""!==c&&($(t).find(".temp span").html(c),$("#device-list .temp").removeClass("hidden"));let p=getHumidity(e);""!==p&&($(t).find(".humidity span").html(p),$("#device-list .humidity").removeClass("hidden"));let u=getPressure(e);""!==u&&($(t).find(".pressure span").html(u),$("#device-list .pressure").removeClass("hidden"));let f=getSeaPressure(e);""!==f&&($(t).find(".seapressure span").html(f),$("#device-list .seapressure").removeClass("hidden"));let h=getDistance(e);""!==h&&($(t).find(".distance span").html(h),$("#device-list .distance").removeClass("hidden"));let m=getGas(e);""!==m&&($(t).find(".gas span").html(m),$("#device-list .gas").removeClass("hidden"));let v=e.idx?e.idx:"";""!==v&&($(t).find(".idx span").html(v),$("#device-list .idx").removeClass("hidden").show()),$(t).find(".version span").html(e.StatusFWR.Version),$(t).hasClass("toggled")?$(t).removeClass("toggled"):"ON"===a?($(t).find(".status").find("input").prop("checked","checked").parent().removeClass("error"),1===n?$(t).find(".status").find("input").prop("disabled","disabled").parent().addClass("disabled"):$(t).find(".status").find("input").removeProp("disabled","disabled").parent().removeClass("disabled")):"NONE"===a?($(t).find(".status").find("input").prop("disabled","disabled").parent().addClass("disabled"),$(t).find(".status").find("input").removeProp("checked").parent().removeClass("error"),$(t).find(".status").find("label").addClass("d-none")):(1===d?$(t).find(".status").find("input").prop("disabled","disabled").parent().addClass("disabled"):$(t).find(".status").find("input").removeProp("disabled","disabled").parent().removeClass("disabled"),$(t).find(".status").find("input").removeProp("checked").parent().removeClass("error")),$(t).find(".rssi span").html(s+"%").attr("data-original-title",i).attr("data-toggle","tooltip").tooltip({html:!0,delay:700});let S=void 0!==e.StatusPRM.StartupDateTimeUtc?e.StatusPRM.StartupDateTimeUtc:void 0!==e.StatusPRM.StartupUTC?e.StatusPRM.StartupUTC:"";if(""!==S){let e=S+"Z".replace(/-/g,"/");e=new Date(e);let a=(new Date-e)/1e3,s=Math.floor(a/86400),i=Math.floor((a-86400*s)/3600),d=Math.floor((a-86400*s-3600*i)/60),n=Math.floor(a-86400*s-3600*i-60*d);o=(0!==s?s+$.i18n("UPTIME_SHORT_DAY"):"")+" "+(0!==i||0!==s?i+$.i18n("UPTIME_SHORT_HOUR"):"")+" "+(0!==d||0!==i||0!==s?d+$.i18n("UPTIME_SHORT_MIN"):"")+" "+(0!==n||0!==d||0!==i?n+$.i18n("UPTIME_SHORT_SEC"):"-"),o=$.trim(o),$(t).find(".runtime span").html(o).attr("data-original-title",e.toLocaleString($("html").attr("lang")+"-"+$("html").attr("lang").toUpperCase(),{hour12:!1})).attr("data-toggle","tooltip").tooltip({html:!0,delay:700})}else console.log(o),$(t).find(".runtime span").html(o+"h");$(t).find(".hostname span").hasClass("dont-update")||$(t).find(".hostname span").html(void 0!==e.StatusNET.Hostname?e.StatusNET.Hostname:"?"),$(t).find(".mac span").hasClass("dont-update")||$(t).find(".mac span").html(void 0!==e.StatusNET.Mac?e.StatusNET.Mac:"?"),$(t).find(".mqtt span").hasClass("dont-update")||$(t).find(".mqtt span").html(void 0!==e.StatusMQT?"1":"0"),$(t).find(".poweronstate span").hasClass("dont-update")||$(t).find(".poweronstate span").html(void 0!==e.Status.PowerOnState?e.Status.PowerOnState:"?"),$(t).find(".ledstate span").hasClass("dont-update")||$(t).find(".ledstate span").html(void 0!==e.Status.LedState?e.Status.LedState:"?"),$(t).find(".savedata span").hasClass("dont-update")||$(t).find(".savedata span").html(void 0!==e.Status.SaveData?e.Status.SaveData:"?"),$(t).find(".sleep span").hasClass("dont-update")||$(t).find(".sleep span").html(void 0!==e.StatusPRM.Sleep?e.StatusPRM.Sleep+"ms":"?"),$(t).find(".bootcount span").html(void 0!==e.StatusPRM.BootCount?e.StatusPRM.BootCount:"?"),$(t).find(".savecount span").html(void 0!==e.StatusPRM.SaveCount?e.StatusPRM.SaveCount:"?"),$(t).find(".log span").html((void 0!==e.StatusLOG.SerialLog?e.StatusLOG.SerialLog:"?")+"|"+(void 0!==e.StatusLOG.WebLog?e.StatusLOG.WebLog:"?")+"|"+(void 0!==e.StatusLOG.SysLog?e.StatusLOG.SysLog:"?")),$(t).find(".wificonfig span").hasClass("dont-update")||$(t).find(".wificonfig span").html(void 0!==e.StatusNET.WifiConfig?e.StatusNET.WifiConfig:"?"),$(t).find(".vcc span").html(void 0!==e.StatusSTS.Vcc?e.StatusSTS.Vcc+"V":"?"),$(".doubleScroll-scroll").css({width:$("#device-list").width()}).parent().trigger("resize"),$(t).removeClass("updating")}$(document).on("ready",(function(){deviceTools(),updateAllStatus(),initCommandHelper(),$(".showmore").on("change",(function(t){$(this).prop("checked")?($(".showmore").prop("checked",!0),Cookies.set("devices_show_more","1"),$("#device-list .more:not(.hidden)").show(),$("label[for="+$(".showmore").attr("id")+"]").removeClass("btn-secondary").addClass("btn-primary")):($(".showmore").prop("checked",!1),Cookies.set("devices_show_more","0"),$("#device-list .more").hide(),$("label[for="+$(".showmore").attr("id")+"]").removeClass("btn-primary").addClass("btn-secondary")),$(".doubleScroll-scroll").css({width:$("#device-list").width()}).parent().trigger("resize")})),$(".ignoreProtections").on("change",(function(t){clearTimeout(ignoreProtectionsTimer),$(this).prop("checked")?(ignoreProtectionsTimer=setTimeout((function(t){$(".ignoreProtections").prop("checked",!1),$("label[for="+$(".ignoreProtections").attr("id")+"]").removeClass("btn-primary").addClass("btn-secondary"),$("label[for="+$(".ignoreProtections").attr("id")+"]").find("i").removeClass("fa-lock-open")}),6e4),$(".ignoreProtections").prop("checked",!0),$("label[for="+$(".ignoreProtections").attr("id")+"]").removeClass("btn-secondary").addClass("btn-primary"),$("label[for="+$(".ignoreProtections").attr("id")+"]").find("i").addClass("fa-lock-open")):($(".ignoreProtections").prop("checked",!1),$("label[for="+$(".ignoreProtections").attr("id")+"]").removeClass("btn-primary").addClass("btn-secondary"),$("label[for="+$(".ignoreProtections").attr("id")+"]").find("i").removeClass("fa-lock-open"))})),void 0!==Cookies.get("devices_show_more")&&"1"==Cookies.get("devices_show_more")&&($(".showmore").prop("checked",!0),$("#device-list .more:not(.hidden)").show(),$("label[for="+$(".showmore").attr("id")+"]").removeClass("btn-secondary").addClass("btn-primary"),$(".doubleScroll-scroll").css({width:$("#device-list").width()}).parent().trigger("resize")),$(".table-responsive").attachDragger(),refreshtime?(console.log("[Global][Refreshtime]"+refreshtime+"ms"),setInterval((function(){console.log("[Global][Refreshtime] updateStatus now"),updateStatus()}),refreshtime)):console.log("[Global][Refreshtime] "+$.i18n("NO_REFRESH"))}));