var ignoreProtectionsTimer;function initCommandHelper(){$(".showCommandInput").on("click",(function(e){$(this).toggleClass("btn-secondary").toggleClass("btn-primary"),$(".command-hidden").toggleClass("d-none"),$(".cmd_cb").toggleClass("d-none").find("input").prop("checked",!1),$(".cmdContainer ").removeClass("has-error"),$(".cmdContainer ").find("input").val(""),$(".cmdContainer ").find("#commandInputError").html("")})),$(".cmdContainer ").find("input").keypress((function(e){13==e.which&&$(".sendCommand").click()})),$(".select_all").change((function(){let e=this.checked;$("#device-list tr:not(.d-none) .device_checkbox").each((function(){this.checked=e})),$(".select_all").each((function(){this.checked=e}))})),$(".device_checkbox").change((function(){0==this.checked&&$(".select_all").each((function(){this.checked=!1})),$(".device_checkbox:checked").length==$(".device_checkbox").length&&$(".select_all").each((function(){this.checked=!0}))})),$(".sendCommand").on("click",(function(e){$(this).parent().parent().removeClass("has-error").find("#commandInputError").addClass("d-none").html("");let t=$.map($(".cmd_cb:not(.link ) input:not(.select_all):checked"),(function(e,t){return new Array($(e).val())}));if(0===t.length)return $(this).parent().parent().addClass("has-error").find("#commandInputError").removeClass("d-none").html($.i18n("ERROR_COMMAND_NO_DEVICE_SELECTED")),!1;let a=$(this).parent().parent().find(".commandInput").val();if(""===a)return $(this).parent().parent().addClass("has-error").find("#commandInputError").removeClass("d-none").html($.i18n("ERROR_PLS_ENTER_COMMAND")),!1;$.each(t,(function(e,t){console.log(t),Sonoff.generic(t,a,void 0,(function(e){console.log(e);let a=$("[data-device_id="+t+"]:first").find(".device_name a").text().trim();$("#commandInputError").append("ID "+t+" ("+a+") => "+JSON.stringify(e)+"<br/>")}))})),$(this).parent().parent().find("#commandInputError").removeClass("d-none").append($.i18n("SUCCESS_COMMAND_SEND")+"</br>")}))}function updateStatus(){$("#device-list tbody tr").each((function(e,t){let a=$(t).data("device_ip"),s=$(t).data("device_id"),i=$(t).data("device_relais"),d=$(t).data("device_group");if($(t).hasClass("updating"))console.log("[Devices][updateStatus]SKIP get status from "+$(t).data("device_ip"));else{if(console.log("[Devices][updateStatus]get status from "+$(t).data("device_ip")),$(t).addClass("updating"),"multi"===d&&i>1)return void console.log("[Devices][updateStatus]SKIP multi "+$(t).data("device_ip"));Sonoff.getStatus(a,s,i,(function(e){if(!e||e.ERROR||e.WARNING||""===e||void 0===e||void 0!==e.statusText)console.log("ERROR => "+JSON.stringify(e)),"multi"===d?$('#device-list tbody tr[data-device_group="multi"][data-device_ip="'+a+'"]').each((function(e,t){$(t).find(".status").find("input").parent().addClass("error"),$(t).find("td").each((function(e,t){$(t).find(".loader").length>0&&$(t).find("span").html("-")})),$(t).removeClass("updating")})):($(t).find(".status").find("input").parent().addClass("error"),$(t).removeClass("updating"));else if("multi"===d)$('#device-list tbody tr[data-device_group="multi"][data-device_ip="'+a+'"]').each((function(t,a){let s=$(a).data("device_relais"),i=Sonoff.parseDeviceStatus(e,s);updateRow($(a),e,i),$(a).removeClass("updating")}));else{let a=Sonoff.parseDeviceStatus(e,i);console.log(a),updateRow($(t),e,a)}}))}}))}function updateAllStatus(){let e=$("#device-list");if(e.hasClass("updating"))console.log("[Devices][updateAllStatus]SKIP");else{e.addClass("updating"),console.log("[Devices][updateAllStatus]START");let t=15*e.find("tbody tr").length;Sonoff.getAllStatus(t,(function(t){e.find("tbody tr").each((function(e,a){let s=$(a).data("device_id"),i=$(a).data("device_relais"),d=($(a).data("device_group"),t[s]||void 0);if(void 0===d||$.isEmptyObject(d)||d.ERROR||d.WARNING||""===d||void 0!==d.statusText){console.log("[LIST][updateAllStatus]["+s+"][ERROR] DATA => "+JSON.stringify(d)),$(a).hasClass("toggled")?$(a).removeClass("toggled"):$(a).find(".status").find("input").parent().addClass("error");let e=$.i18n("ERROR");void 0!==d?void 0!==d.ERROR?e=d.ERROR:void 0!==d.WARNING?e=d.WARNING:void 0!==d.statusText&&(e=d.statusText):e="data is empty",$(a).attr("data-original-title",e).attr("data-toggle","tooltip").tooltip({html:!0,delay:700}),$(a).find("td").each((function(e,t){$(t).find(".loader").length>0&&$(t).find("span").html("-")}))}else{console.log("[LIST][updateAllStatus]["+s+"]MSG => "+JSON.stringify(d));let e=Sonoff.parseDeviceStatus(d,i);$(a).removeAttr("data-original-title").removeAttr("data-toggle"),updateRow($(a),d,e),$(a).find(".status").find("input").parent().removeClass("error")}})),e.removeClass("updating")}))}}function deviceTools(){$("#device-list tbody tr td.status").on("click",(function(e){e.preventDefault();let t=$(this),a=$(this).closest("tr").data("device_ip"),s=$(this).closest("tr").data("device_id"),i=$(this).closest("tr").data("device_relais"),d=$(this).closest("tr").data("device_protect_on"),o=$(this).closest("tr").data("device_protect_off");if(t.find("input").prop("checked")){if(1===o&&!$(".ignoreProtections").prop("checked"))return;t.find("input").removeProp("checked")}else{if(1===d&&!$(".ignoreProtections").prop("checked"))return;t.find("input").prop("checked","checked")}$(this).closest("tr").addClass("toggled"),Sonoff.toggle(a,s,i,(function(e){if(!e||e.ERROR||e.WARNING)"OFF"===device_status?1===d?t.find("input").prop("disabled","disabled").parent().addClass("disabled"):t.find("input").removeProp("disabled","disabled").parent().removeClass("disabled"):t.find("input").parent().addClass("error");else{let a=Sonoff.parseDeviceStatus(e,i);console.log("device_status",a),"ON"===a&&(1===o?t.find("input").prop("disabled","disabled").parent().addClass("disabled"):t.find("input").removeProp("disabled","disabled").parent().removeClass("disabled"))}}))})),$("#deleteDeviceModal").on("show.bs.modal",(function(e){let t=$(this),a=$(e.relatedTarget);console.log(t.find(".btn-ok")),t.find(".btn-ok").attr("href",a.attr("href"));let s=a.data("dialog-text");t.find(".modal-body").html(s)})),$("#device-list tbody tr td a.restart-device").on("click",(function(e){e.preventDefault();let t=$(this).closest("tr").data("device_id");Sonoff.generic(t,"Restart",1)})),$(document).on("dblclick",".dblcEdit span",(function(){oriVal=$(this).text().toString().trim(),$(this).text("").addClass("dont-update");let e=10*oriVal.toString().length+20;input=$("<input class='dblEdit-Input form-control' type='text' style='width: "+e+"px; padding: 3px;'>"),input.appendTo($(this)).focus()})),$(document).on("focusout keypress",".dblEdit-Input",(function(e){if("keypress"!==e.type||13===e.which)if(""!==input.val()){let e=input.val(),t=$(this).closest("tr").data("device_id"),a=$(this).closest("td").data("target")||"device",s=$(this).closest("td").data("cmnd")||"",i=$(this).closest("td").data("field")||"";$(this).hide();let d=$(this).parent();$(this).parent().removeClass("dont-update").html($.i18n("TEXT_LOADING")).removeClass("dont-update"),"device"==a?Sonoff.updateConfig(t,s,e,updateStatus):"csv"==a&&Sonoff.setDeviceValue(t,i,e,d)}else $(this).parent().removeClass("dont-update").text(oriVal)}))}function updateRow(e,t,a){$(e).data("device_all_off");let s,i,d,o=$(e).data("device_protect_on"),n=$(e).data("device_protect_off"),l="n/A";void 0!==t.StatusFWR&&(l=parseVersion(t.StatusFWR.Version)),l>=510009?(s=t.StatusSTS.Wifi.RSSI,i=t.StatusSTS.Wifi.SSId,d=t.StatusSTS.Uptime):(s=t.StatusSTS.WLAN?t.StatusSTS.WLAN.RSSI:t.StatusSTS.Wifi.RSSI,i=t.StatusSTS.WLAN?t.StatusSTS.WLAN.SSID:t.StatusSTS.Wifi.SSId,d=t.StatusSTS.Laufzeit?t.StatusSTS.Laufzeit:t.StatusSTS.Uptime);let r=getEnergyPower(t);""!==r&&($(e).find(".energyPower span").html(r),$("#device-list .energyPower").removeClass("hidden"));let c=getTemp(t);""!==c&&($(e).find(".temp span").html(c),$("#device-list .temp").removeClass("hidden"));let p=getHumidity(t);""!==p&&($(e).find(".humidity span").html(p),$("#device-list .humidity").removeClass("hidden"));let u=getPressure(t);""!==u&&($(e).find(".pressure span").html(u),$("#device-list .pressure").removeClass("hidden"));let f=getSeaPressure(t);""!==f&&($(e).find(".seapressure span").html(f),$("#device-list .seapressure").removeClass("hidden"));let h=getDistance(t);""!==h&&($(e).find(".distance span").html(h),$("#device-list .distance").removeClass("hidden"));let m=getGas(t);""!==m&&($(e).find(".gas span").html(m),$("#device-list .gas").removeClass("hidden"));let v=t.idx?t.idx:"";""!==v&&($(e).find(".idx span").html(v),$("#device-list .idx").removeClass("hidden").show()),$(e).find(".version span").html(t.StatusFWR.Version),$(e).hasClass("toggled")?$(e).removeClass("toggled"):"ON"===a?($(e).find(".status").find("input").prop("checked","checked").parent().removeClass("error"),1===n?$(e).find(".status").find("input").prop("disabled","disabled").parent().addClass("disabled"):$(e).find(".status").find("input").removeProp("disabled","disabled").parent().removeClass("disabled")):"NONE"===a?($(e).find(".status").find("input").prop("disabled","disabled").parent().addClass("disabled"),$(e).find(".status").find("input").removeProp("checked").parent().removeClass("error"),$(e).find(".status").find("label").addClass("d-none")):(1===o?$(e).find(".status").find("input").prop("disabled","disabled").parent().addClass("disabled"):$(e).find(".status").find("input").removeProp("disabled","disabled").parent().removeClass("disabled"),$(e).find(".status").find("input").removeProp("checked").parent().removeClass("error")),$(e).find(".rssi span").html(s+"%").attr("data-original-title",i).attr("data-toggle","tooltip").tooltip({html:!0,delay:700});let S=void 0!==t.StatusPRM.StartupDateTimeUtc?t.StatusPRM.StartupDateTimeUtc:void 0!==t.StatusPRM.StartupUTC?t.StatusPRM.StartupUTC:"";if(""!==S){let t=S+"Z".replace(/-/g,"/");t=new Date(t);let a=(new Date-t)/1e3,s=Math.floor(a/86400),i=Math.floor((a-86400*s)/3600),o=Math.floor((a-86400*s-3600*i)/60),n=Math.floor(a-86400*s-3600*i-60*o);d=(0!==s?s+$.i18n("UPTIME_SHORT_DAY"):"")+" "+(0!==i||0!==s?i+$.i18n("UPTIME_SHORT_HOUR"):"")+" "+(0!==o||0!==i||0!==s?o+$.i18n("UPTIME_SHORT_MIN"):"")+" "+(0!==n||0!==o||0!==i?n+$.i18n("UPTIME_SHORT_SEC"):"-"),d=$.trim(d),$(e).find(".runtime span").html(d).attr("data-original-title",t.toLocaleString($("html").attr("lang")+"-"+$("html").attr("lang").toUpperCase(),{hour12:!1})).attr("data-toggle","tooltip").tooltip({html:!0,delay:700})}else console.log(d),$(e).find(".runtime span").html(d+"h");$(e).find(".hostname span").hasClass("dont-update")||$(e).find(".hostname span").html(void 0!==t.StatusNET.Hostname?t.StatusNET.Hostname:"?"),$(e).find(".mac span").hasClass("dont-update")||$(e).find(".mac span").html(void 0!==t.StatusNET.Mac?t.StatusNET.Mac:"?"),$(e).find(".mqtt span").hasClass("dont-update")||$(e).find(".mqtt span").html(void 0!==t.StatusMQT?"1":"0"),$(e).find(".poweronstate span").hasClass("dont-update")||$(e).find(".poweronstate span").html(void 0!==t.Status.PowerOnState?t.Status.PowerOnState:"?"),$(e).find(".ledstate span").hasClass("dont-update")||$(e).find(".ledstate span").html(void 0!==t.Status.LedState?t.Status.LedState:"?"),$(e).find(".savedata span").hasClass("dont-update")||$(e).find(".savedata span").html(void 0!==t.Status.SaveData?t.Status.SaveData:"?"),$(e).find(".sleep span").hasClass("dont-update")||$(e).find(".sleep span").html(void 0!==t.StatusPRM.Sleep?t.StatusPRM.Sleep+"ms":"?"),$(e).find(".bootcount span").html(void 0!==t.StatusPRM.BootCount?t.StatusPRM.BootCount:"?"),$(e).find(".savecount span").html(void 0!==t.StatusPRM.SaveCount?t.StatusPRM.SaveCount:"?"),$(e).find(".log span").html((void 0!==t.StatusLOG.SerialLog?t.StatusLOG.SerialLog:"?")+"|"+(void 0!==t.StatusLOG.WebLog?t.StatusLOG.WebLog:"?")+"|"+(void 0!==t.StatusLOG.SysLog?t.StatusLOG.SysLog:"?")),$(e).find(".wificonfig span").hasClass("dont-update")||$(e).find(".wificonfig span").html(void 0!==t.StatusNET.WifiConfig?t.StatusNET.WifiConfig:"?"),$(e).find(".vcc span").html(void 0!==t.StatusSTS.Vcc?t.StatusSTS.Vcc+"V":"?");let g=Sonoff.parseDeviceHostname(t);!1!==g&&$(e).data("keywords",$(e).data("keywords")+" "+g),$(".doubleScroll-scroll").css({width:$("#device-list").width()}).parent().trigger("resize"),$(e).removeClass("updating")}function initDeviceFilter(){$(".device-search").on("keyup",(function(e){let t=$(this).val().trim(),a=$("#device-list").find("tr");if(""!==t){let e=new RegExp(t,"i");$.each(a,(function(t,s){let i=$(s);if(0===t||t===a.length-1)return;let d=i.data("keywords");void 0!==d&&""!==d?e.test(d)?i.removeClass("d-none"):(i.addClass("d-none"),i.find(".device_checkbox").prop("checked",!1)):i.addClass("d-none")}))}else a.removeClass("d-none")}))}$(document).on("ready",(function(){deviceTools(),updateAllStatus(),initCommandHelper(),$(".device-search").length>0&&initDeviceFilter(),$(".showmore").on("change",(function(e){$(this).prop("checked")?($(".showmore").prop("checked",!0),Cookies.set("devices_show_more","1"),$("#device-list .more:not(.hidden)").show(),$("label[for="+$(".showmore").attr("id")+"]").removeClass("btn-secondary").addClass("btn-primary")):($(".showmore").prop("checked",!1),Cookies.set("devices_show_more","0"),$("#device-list .more").hide(),$("label[for="+$(".showmore").attr("id")+"]").removeClass("btn-primary").addClass("btn-secondary")),$(".doubleScroll-scroll").css({width:$("#device-list").width()}).parent().trigger("resize")})),$(".ignoreProtections").on("change",(function(e){clearTimeout(ignoreProtectionsTimer),$(this).prop("checked")?(ignoreProtectionsTimer=setTimeout((function(e){$(".ignoreProtections").prop("checked",!1),$("label[for="+$(".ignoreProtections").attr("id")+"]").removeClass("btn-primary").addClass("btn-secondary"),$("label[for="+$(".ignoreProtections").attr("id")+"]").find("i").removeClass("fa-lock-open")}),6e4),$(".ignoreProtections").prop("checked",!0),$("label[for="+$(".ignoreProtections").attr("id")+"]").removeClass("btn-secondary").addClass("btn-primary"),$("label[for="+$(".ignoreProtections").attr("id")+"]").find("i").addClass("fa-lock-open")):($(".ignoreProtections").prop("checked",!1),$("label[for="+$(".ignoreProtections").attr("id")+"]").removeClass("btn-primary").addClass("btn-secondary"),$("label[for="+$(".ignoreProtections").attr("id")+"]").find("i").removeClass("fa-lock-open"))})),void 0!==Cookies.get("devices_show_more")&&"1"==Cookies.get("devices_show_more")&&($(".showmore").prop("checked",!0),$("#device-list .more:not(.hidden)").show(),$("label[for="+$(".showmore").attr("id")+"]").removeClass("btn-secondary").addClass("btn-primary"),$(".doubleScroll-scroll").css({width:$("#device-list").width()}).parent().trigger("resize")),$(".table-responsive").attachDragger(),refreshtime?(console.log("[Global][Refreshtime]"+refreshtime+"ms"),setInterval((function(){console.log("[Global][Refreshtime] updateStatus now"),updateStatus()}),refreshtime)):console.log("[Global][Refreshtime] "+$.i18n("NO_REFRESH"))}));