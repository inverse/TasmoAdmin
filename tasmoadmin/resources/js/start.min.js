var longPressTimer;function updateStatus(){$("#content .box_device:not(#all_off)").each((function(e,t){let a=$(t).data("device_ip"),o=$(t).data("device_id"),s=$(t).data("device_relais"),i=$(t).data("device_group");if(!$(t).hasClass("updating")){if(console.log("[Start][updateStatus]get status from "+$(t).data("device_ip")),"multi"===i&&s>1)return void console.log("[Start][updateStatus]skip multi "+$(t).data("device_ip"));$(t).addClass("updating"),Sonoff.getStatus(a,o,s,(function(e){if(!e||e.ERROR||e.WARNING||""===e||void 0===e||void 0!==e.statusText)if(console.log("ERROR => "+JSON.stringify(e)),"multi"===i)$('#device-list tbody tr[data-device_group="multi"][data-device_ip="'+a+'"]').each((function(e,t){$(t).addClass("error").find(".animated").removeClass("animated"),$(t).removeClass("updating");let a=$(t).find("img"),o=_RESOURCESURL_+"img/device_icons/"+a.data("icon")+"_error.png?v=160";a.attr("src",o)}));else{$(t).addClass("error").find(".animated").removeClass("animated"),$(t).removeClass("updating");let e=$(t).find("img"),a=_RESOURCESURL_+"img/device_icons/"+e.data("icon")+"_error.png?v=160";e.attr("src",a)}else if("multi"===i)$('#content .box_device[data-device_group="multi"][data-device_ip="'+a+'"]').each((function(t,a){let o=$(a).find("img"),s=_RESOURCESURL_+"img/device_icons/"+o.data("icon")+"_%pw.png?v=160",i=$(a).data("device_relais"),n=Sonoff.parseDeviceStatus(e,i);console.log(n.toLowerCase()),s=s.replace("%pw",n.toLowerCase()),o.attr("src",s).parent().removeClass("animated"),updateBox($(a),e,n),$(a).removeClass("error").find(".animated").removeClass("animated"),$(a).removeClass("updating")}));else{let a=$(t).find("img"),o=_RESOURCESURL_+"img/device_icons/"+a.data("icon")+"_%pw.png?v=160",s=Sonoff.parseDeviceStatus(e,1);console.log("device_status",s),void 0!==s&&($(t).data("device_state",s.toLowerCase()),o=o.replace("%pw",s.toLowerCase()),a.attr("src",o).parent().removeClass("animated"),console.log("$( box )",$(t)),"NONE"===s&&$(t).data("device_group","sensor")),updateBox($(t),e,s),$(t).removeClass("error").find(".animated").removeClass("animated"),$(t).removeClass("updating")}}))}}))}function deviceTools(){$("#content .box_device:not(#all_off)").on("mousedown touchstart",(function(){clearTimeout(longPressTimer);let e=$(this);e.hasClass("disabled")&&(longPressTimer=setTimeout((function(){e.addClass("ignoreProtection"),clearTimeout(longPressTimer),setTimeout((function(){e.addClass("ignoreProtection")}),6e4)}),5e3))})).on("mouseup mouseleave touchend touchmove",(function(){clearTimeout(longPressTimer)})),$("#content .box_device:not(#all_off)").on("mouseup touchend",(function(e){e.preventDefault();let t=$(this),a=t.data("device_ip"),o=t.data("device_id"),s=t.data("device_relais"),i=t.data("device_group"),n=t.data("device_state"),d=t.data("device_protect_on"),r=t.data("device_protect_off");"sensor"!==i?$(this).hasClass("toggled")?console.log("[Start][updateStatus]is toggling "+t.data("device_ip")):("on"!==n||1!==r||t.hasClass("ignoreProtection"))&&("off"!==n||1!==d||t.hasClass("ignoreProtection"))&&($(this).addClass("toggled"),t.find("img").shake(3,5,500),Sonoff.toggle(a,o,s,(function(e){if(!e||e.ERROR||e.WARNING){t.addClass("error");let o=t.find("img"),s=_RESOURCESURL_+"img/device_icons/"+o.data("icon")+"_error.png?v=160";o.attr("src",s).parent().removeClass("animated"),console.log("[Start][toggle]ERROR "+a+" => "+e.ERROR||"Unknown Error")}else{let a=t.find("img"),o=_RESOURCESURL_+"img/device_icons/"+a.data("icon")+"_%pw.png?v=160",i=Sonoff.parseDeviceStatus(e,s);void 0!==i&&(t.data("device_state",i.toLowerCase()),o=o.replace("%pw",i.toLowerCase()),a.attr("src",o),updateStatus()),a.parent().removeClass("animated"),t.removeClass("error")}$("#content .box_device").removeClass("toggled")}))):console.log("[Start][updateStatus]skip sensor "+t.data("device_ip"))})),$("#all_off").on("click",(function(e){e.preventDefault(),$("#content .box_device:not(#all_off)").each((function(e,t){let a=$(t).data("device_ip"),o=$(t).data("device_id"),s=$(t).data("device_relais"),i=$(t).data("device_group"),n=$(t).data("device_all_off");$(t).data("device_protect_on"),$(t).data("device_protect_off");console.log("[Start][updateStatus]get status from "+$(t).data("device_ip")),"multi"===i&&s>1?console.log("[Start][updateStatus]skip multi "+$(t).data("device_ip")):"sensor"!==i?1===n?Sonoff.off(a,o,s,(function(e){if(!e||e.ERROR||e.WARNING){$(t).addClass("error");let o=device_box.find("img"),s=_RESOURCESURL_+"img/device_icons/"+o.data("icon")+"_error.png?v=160";o.attr("src",s).parent().removeClass("animated"),console.log("[Start][toggle]ERROR "+a+" => "+e.ERROR||"Unknown Error")}else{let a=$(t).find("img"),o=_RESOURCESURL_+"img/device_icons/"+a.data("icon")+"_%pw.png?v=160",i=Sonoff.parseDeviceStatus(e,s);void 0!==i&&($(t).data("state",i),o=o.replace("%pw",i.toLowerCase()),a.attr("src",o)),a.parent().removeClass("animated"),$(t).removeClass("error")}})):console.log("[Start][updateStatus]skip excluded "+$(t).data("device_ip")):console.log("[Start][updateStatus]skip sensor "+$(t).data("device_ip"))}))}))}function updateBox(e,t,a){let o,s,i,n=$(e).data("device_protect_on"),d=$(e).data("device_protect_off"),r="n/A";void 0!==t.StatusFWR&&(r=parseVersion(t.StatusFWR.Version)),r>=510009?(o=t.StatusSTS.Wifi.RSSI,s=t.StatusSTS.Wifi.SSId,i=t.StatusSTS.Uptime):(o=t.StatusSTS.WLAN?t.StatusSTS.WLAN.RSSI:t.StatusSTS.Wifi.RSSI,s=t.StatusSTS.WLAN?t.StatusSTS.WLAN.SSID:t.StatusSTS.Wifi.SSId,i="undefined"!==t.StatusSTS.Laufzeit?t.StatusSTS.Laufzeit:t.StatusSTS.Uptime);let l=1,c=getTemp(t,", ");""!==c&&($(e).find(".info-"+l+" span").html(c).parent().removeClass("hidden"),l++);let u=getHumidity(t,", ");""!==u&&($(e).find(".info-"+l+" span").html(u).parent().removeClass("hidden"),l++);let S=getPressure(t,", ");""!==S&&($(e).find(".info-"+l+" span").html(S).parent().removeClass("hidden"),l++);let v=getSeaPressure(t,", ");""!==v&&($(e).find(".info-"+l+" span").html(v).parent().removeClass("hidden"),l++);let f=getDistance(t,", ");""!==f&&($(e).find(".info-"+l+" span").html(f).parent().removeClass("hidden"),l++);let p=getEnergyPower(t,", ");""!==p&&($(e).find(".info-"+l+" span").html(p).parent().removeClass("hidden"),l++);let m=getGas(t,", ");""!==m&&($(e).find(".info-"+l+" span").html(m).parent().removeClass("hidden"),l++);let g=t.idx?t.idx:"";""!==g&&($(e).find(".idx span").html(g),$("#device-list .idx").removeClass("hidden").show()),$(e).find(".version span").html(t.StatusFWR.Version),$(e).data("device_state",a.toLowerCase()),"ON"===a?($(e).find(".status").find("input").prop("checked","checked").parent().removeClass("error"),1===d?$(e).addClass("disabled"):$(e).removeClass("disabled")):($(e).find(".status").find("input").removeProp("checked").parent().removeClass("error"),1===n?$(e).addClass("disabled"):$(e).removeClass("disabled")),$(e).find(".rssi span").html(o+"%").attr("title",s),$(e).find(".runtime span").html("~"+i+"h"),$(e).find(".hostname span").html(void 0!==t.StatusNET.Hostname?t.StatusNET.Hostname:"?"),$(e).find(".mac span").html(void 0!==t.StatusNET.Mac?t.StatusNET.Mac:"?"),$(e).find(".mqtt span").html(void 0!==t.StatusMQT?"1":"0"),$(e).find(".poweronstate span").html(void 0!==t.Status.PowerOnState?t.Status.PowerOnState:"?"),$(e).find(".ledstate span").html(void 0!==t.Status.LedState?t.Status.LedState:"?"),$(e).find(".savedata span").html(void 0!==t.Status.SaveData?t.Status.SaveData:"?"),$(e).find(".sleep span").html(void 0!==t.StatusPRM.Sleep?t.StatusPRM.Sleep+"ms":"?"),$(e).find(".bootcount span").html(void 0!==t.StatusPRM.BootCount?t.StatusPRM.BootCount:"?"),$(e).find(".savecount span").html(void 0!==t.StatusPRM.SaveCount?t.StatusPRM.SaveCount:"?"),$(e).find(".log span").html((void 0!==t.StatusLOG.SerialLog?t.StatusLOG.SerialLog:"?")+"|"+(void 0!==t.StatusLOG.WebLog?t.StatusLOG.WebLog:"?")+"|"+(void 0!==t.StatusLOG.SysLog?t.StatusLOG.SysLog:"?")),$(e).find(".wificonfig span").html(void 0!==t.StatusNET.WifiConfig?t.StatusNET.WifiConfig:"?"),$(e).find(".vcc span").html(void 0!==t.StatusSTS.Vcc?t.StatusSTS.Vcc+"V":"?"),$(e).removeClass("updating")}$(document).on("ready",(function(){deviceTools(),updateStatus(),refreshtime?(console.log("[Global][Refreshtime]"+refreshtime+"ms"),setInterval((function(){updateStatus()}),refreshtime)):console.log("[Global][Refreshtime]Dont refresh")}));